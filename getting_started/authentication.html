

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Authentication &mdash; MatrixCtl None.0.15.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=4c3836bf"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="SSH Public Key" href="ssh_pubkey.html" />
    <link rel="prev" title="Synapse Playbook" href="synapse_playbook.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            MatrixCtl
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="config_file.html">Config File</a></li>
<li class="toctree-l2"><a class="reference internal" href="synapse_playbook.html">Synapse Playbook</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="ssh_pubkey.html">SSH Public Key</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributer_documentation/index.html">Contributor Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html#changelog-deprecated">Changelog (deprecated)</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MatrixCtl</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Getting Started</a></li>
      <li class="breadcrumb-item active">Authentication</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/getting_started/authentication.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="authentication">
<h1>Authentication<a class="headerlink" href="#authentication" title="Link to this heading"></a></h1>
<p>MatrixCtl supports two different ways to authenticate against the Synapse API.</p>
<p>1. OpenID Connect
1. Access Token</p>
<section id="openid-connect">
<h2>OpenID Connect<a class="headerlink" href="#openid-connect" title="Link to this heading"></a></h2>
<p>Since MAS (the Matrix Authentication Service) has become stable it became the
default authentication method for many of us, it also brought the feature of
refresh tokens. This means that the access token method still works, but
the access tokens expire after a couple of minutes. This means that you
have to swap them out basically every time you run a command. Getting long
lived access tokens is not easy anymore. Therefore we added OpenID Connect
support to MatrixCtl. Just like any other Matrix client, that is using MAS,
MatrixCtl will do the same.</p>
<p>We have written a simple OpenID Connect client for it that handles the
token refreshing for you.</p>
<p>To get started with OpenID Connect, you need to create a
<a class="reference external" href="https://element-hq.github.io/matrix-authentication-service/reference/configuration.html#clients">new client</a>
on your MAS instance.</p>
<p>For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">client_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">01JVZSJNTM8EPFCA9R55V2PFW9</span>
<span class="w">  </span><span class="nt">client_auth_method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">client_secret_post</span>
<span class="w">  </span><span class="nt">client_secret</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7eQgWf5XIwIVkrVmzc5nxw731u4Riu16YK1oHOfTDR2xU4iD7C7ijiSD8wclfTDn</span>
<span class="w">  </span><span class="nt">redirect_uris</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://127.0.0.1:8298/callback</span>
</pre></div>
</div>
<p>The <cite>client_id</cite> has to be a valid ULID. You can generate one using an
<a class="reference external" href="https://ulidgenerator.com">ulid generator</a>.
The <cite>client_secret</cite>, for example can be generated using the <cite>openssl</cite> command:
<cite>openssl rand -base64 32 | tr -d ‘n’</cite> or <cite>pwgen -s 64 1</cite>. The <cite>redirect_uris</cite>
is will be a list that only contains one entry,
<cite>http://127.0.0.1:8298/callback</cite>. The <cite>client_auth_method</cite> must be
<cite>client_secret_post</cite></p>
<p>That’s all we need to make MAS acquainted with MatrixCtl. Now we need to
tell MatrixCtl about the MAS, our OpenID provider.</p>
<p>Open the <cite>config.yml</cite> file and add the following lines to it:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">servers</span><span class="p">:</span>
<span class="w">  </span><span class="nt">default</span><span class="p">:</span>
<span class="w">    </span><span class="nt">api</span><span class="p">:</span>
<span class="w">      </span><span class="nt">domain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yourdomain.tld</span>
<span class="w">      </span><span class="nt">auth_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">oidc</span>
<span class="w">      </span><span class="nt">auth_oidc</span><span class="p">:</span>
<span class="w">        </span><span class="nt">client_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">01JVZSJNTM8EPFCA9R55V2PFW9</span>
<span class="w">        </span><span class="nt">client_secret</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7eQgWf5XIwIVkrVmzc5nxw731u4Riu16YK1oHOfTDR2xU4iD7C7ijiSD8wclfTDn</span>
<span class="w">        </span><span class="nt">discovery_endpoint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://mas.yourdomain.tld/.well-known/openid-configuration</span>

<span class="w">        </span><span class="c1"># Optional, when discovery_endpoint is not set</span>
<span class="w">        </span><span class="c1"># token_endpoint:</span>
<span class="w">        </span><span class="c1"># auth_endpoint:</span>
<span class="w">        </span><span class="c1"># userinfo_endpoint:</span>
<span class="w">        </span><span class="c1"># jwks_uri:</span>
</pre></div>
</div>
<p>To use OpenID Connect, you first need to set the <cite>auth_type</cite> to <cite>oidc</cite>. Then
you either need to set the <cite>discovery_endpoint</cite> (recommended) or fill out the
<cite>token_endpoint</cite>, <cite>auth_endpoint</cite>, <cite>userinfo_endpoint</cite>, <cite>jwks_uri</cite>.
Then you copy the <cite>client_id</cite> and <cite>client_secret</cite> from the client you created.
Make sure not to share the <cite>client_secret</cite> with anyone else.
This is the secret that is used to authenticate MatrixCtl against the OpenID
provider.</p>
<p>Now, when the Synapse API is called for the first time, MatrixCtl will use the
OpenID Connect browser flow to authenticate against the OpenID provider.
This will launch a browser window and ask you to login. After you have logged
in, the browser will redirect to the <cite>redirect_uri</cite> you set in the client.</p>
<p>If everything went well, you will be authenticated and you can use MatrixCtl
just like before. The current, short lived acces token will be stored,
together with the refresh token and expire information in
<cite>${XDG_DATA_HOME}/matrixctl/oidc_token_cache.json</cite> (most likely
<cite>~/.local/share/matrixctl/oidc_token_cache.json</cite>). Just like with the
client_secret, make sure not to share this file with anyone else.</p>
</section>
<section id="access-token">
<h2>Access Token<a class="headerlink" href="#access-token" title="Link to this heading"></a></h2>
<p>If you haven’t jumped onto the OpenID Connect bandwagon yet, you can still use
MatrixCtl with the access token method. This is the old way of doing things
and is less complex than using OpenID Connect. The access token is a long lived
(when not using MAS) and can be found in the Element web client. As long as
the element session is active, the access token is valid.</p>
<p>If you don’t have any users yet, and you are using the Ansible playbook, you
can easily create a user account with the playbook. Just run the following
command (given, that you configured the playbook in the MatrixCtl config file).
If you already have a user account, you can skip this step and continue below.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>matrixctl<span class="w"> </span>adduser<span class="w"> </span>--ansible<span class="w"> </span>--admin<span class="w"> </span>myusername
<span class="go">Password:</span>
<span class="go">Password (again):</span>
<span class="go">Username: myusername</span>
<span class="go">Password: **HIDDEN**</span>
<span class="go">Admin:    yes</span>
<span class="go">Is everything ok? [y/n]y</span>

<span class="go">PLAY [Set up a Matrix server] *********************************************************************************</span>

<span class="go">[...]</span>

<span class="go">PLAY RECAP ****************************************************************************************************</span>
<span class="go">matrix.michaelsasser.org   : ok=24   changed=0    unreachable=0    failed=0    skipped=34   rescued=0    ignored=0</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you don’t enter a password and press [ENTER] twice, a password
will be generated for you. If you are satisfied with it, enter [y].</p>
</div>
<p>Now you have created your user with the user name “myusername”. The argument
<code class="docutils literal notranslate"><span class="pre">--admin</span></code> makes sure, that you create an administrator account instead of an
user account. The <code class="docutils literal notranslate"><span class="pre">--ansible</span></code> argument is needed, because you currently have
no access to the admin API. After all that steps you don’t need the
<code class="docutils literal notranslate"><span class="pre">--ansible</span></code> argument anymore.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can use this user account as your personal main user account.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you have already created an admin user account ignore this step
and continue below.</p>
</div>
<p>Now Open <code class="docutils literal notranslate"><span class="pre">https://element.yourdomain.tld</span></code> to login.</p>
<figure class="align-center" id="id1">
<img alt="login screen image" src="../_images/loginscreen.png" />
<figcaption>
<p><span class="caption-number">Fig. 1 </span><span class="caption-text">The Element loginscreen</span><a class="headerlink" href="#id1" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>Click on “Sign In” and enter your credentials. In this example, we used
“myusername” for the user and the entered password to login.</p>
<figure class="align-center" id="id2">
<img alt="login screen login image" src="../_images/loginscreen_login.png" />
<figcaption>
<p><span class="caption-number">Fig. 2 </span><span class="caption-text">Entering credentials</span><a class="headerlink" href="#id2" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>After you are logged in, click on your user name in the top right corner. A
small window will pop up. Click on <code class="docutils literal notranslate"><span class="pre">Settings</span></code>.</p>
<figure class="align-center" id="id3">
<img alt="click on settings image" src="../_images/click_on_settings.png" />
<figcaption>
<p><span class="caption-number">Fig. 3 </span><span class="caption-text">Click on “Settings”</span><a class="headerlink" href="#id3" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>A bigger window with your user settings will pop up. Click on <code class="docutils literal notranslate"><span class="pre">Help</span> <span class="pre">&amp;</span> <span class="pre">About</span></code>
on the left side of that window. If you scroll down on the right
hand side of this window, you will find the <code class="docutils literal notranslate"><span class="pre">Advanced</span></code> section.
In the Advanced section you find <code class="docutils literal notranslate"><span class="pre">Access</span> <span class="pre">Token:</span> <span class="pre">&lt;click</span> <span class="pre">to</span> <span class="pre">reveal&gt;</span></code>.</p>
<figure class="align-center" id="id4">
<img alt="click on reveal access token image" src="../_images/reveal_access_token.png" />
<figcaption>
<p><span class="caption-number">Fig. 4 </span><span class="caption-text">Click on “&lt;click to reveal&gt;”</span><a class="headerlink" href="#id4" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>Now click on <code class="docutils literal notranslate"><span class="pre">&lt;click</span> <span class="pre">to</span> <span class="pre">reveal&gt;</span></code>.</p>
<figure class="align-center" id="id5">
<img alt="the revealed access token image" src="../_images/revealed_access_token.png" />
<figcaption>
<p><span class="caption-number">Fig. 5 </span><span class="caption-text">The revealed access token</span><a class="headerlink" href="#id5" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>This is your access token. It is already highlighted for you. Just copy it into
the config file into the <code class="docutils literal notranslate"><span class="pre">api</span></code> section.</p>
</section>
<section id="copy-the-token">
<h2>Copy The Token<a class="headerlink" href="#copy-the-token" title="Link to this heading"></a></h2>
<p>Now you can copy the token into the <code class="docutils literal notranslate"><span class="pre">api</span></code> section of your config file.
If you don’t have a config file head over to the <a class="reference internal" href="config_file.html#config-file"><span class="std std-ref">Config File</span></a> chapter.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">...</span>
<span class="l l-Scalar l-Scalar-Plain">api.</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">domain</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yourdomain.tld</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">token</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MDAxZmxvY2F0aW9uIG1pY2hhZWxzYXNzZXIub3JnCjAwMTNpZGVudGlmaWVyIGtleQowMDEwY2lkIGdlbiA9IDEKMDAzMGNpZCB1c2VyX2lkID0gQG15dXNlcm5hbWU6bWljaGFlbHNhc3Nlci5vcmcKMDAxNmNpZCB0eXBlID0gYWNjZXNzCjAwMjFjaWQgbm9uY2UgPSA3WkB1KkdyY3JTRG1CI3Z0CjAwMmZzaWduYXR1cmUgJblnYOAEQJVeHaMgwnMsAagpZBc8CIC6Dwwy027tfJAK</span>
<span class="nn">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To be able to use the admin API, you need to have
<code class="docutils literal notranslate"><span class="pre">matrix_static_files_container_labels_base_domain_enabled:</span> <span class="pre">true</span></code>
and
<code class="docutils literal notranslate"><span class="pre">matrix_synapse_container_labels_public_client_synapse_admin_api_enabled:</span> <span class="pre">true</span></code>
in your <code class="docutils literal notranslate"><span class="pre">vars.yml</span> <span class="pre">file.</span> <span class="pre">This</span> <span class="pre">will</span> <span class="pre">stop</span> <span class="pre">the</span> <span class="pre">playbook</span> <span class="pre">from</span> <span class="pre">setting</span>
<span class="pre">up</span> <span class="pre">a</span> <span class="pre">redirect</span> <span class="pre">``matrix.yourdomain.tld</span></code> to
<code class="docutils literal notranslate"><span class="pre">element.yourdomain.tld</span></code></p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Never ever, ever give this token to anyone else. If you have other
administrators on that server, they should use their own token.
With this token you can login and do anything on that matrix
instance in <strong>your name</strong>.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="synapse_playbook.html" class="btn btn-neutral float-left" title="Synapse Playbook" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="ssh_pubkey.html" class="btn btn-neutral float-right" title="SSH Public Key" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Michael Sasser.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>